// Generated by CoffeeScript 1.6.3
var assert, does, facto, parallel, spectate, util, _ref, _ref1;

_ref = require('also'), util = _ref.util, parallel = _ref.parallel;

facto = require('facto');

does = require('does');

_ref1 = does({
  does: {
    mode: 'spec'
  }
}), spectate = _ref1.spectate, assert = _ref1.assert;

module.exports = function(fn) {
  var fnArgs;
  fnArgs = util.argsOf(fn);
  if (fnArgs.length === 0) {
    return function() {
      return fn.call(this);
    };
  }
  return function(done) {
    var inject, nodule, promise, _i, _len,
      _this = this;
    inject = [];
    if (fnArgs[0] === 'done') {
      inject.push(done);
      fnArgs.shift();
    } else {
      if (fnArgs[0] !== 'facto' ? done != null : void 0) {
        done();
      }
    }
    if (fnArgs[0] === 'facto') {
      fnArgs.shift();
      inject.push(function(metadata) {
        assert();
        facto(metadata);
        return done();
      });
      return parallel((function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = fnArgs.length; _i < _len; _i++) {
          nodule = fnArgs[_i];
          _results.push((function(nodule) {
            return function() {
              return spectate(require(nodule));
            };
          })(nodule));
        }
        return _results;
      })()).then(function(nodules) {
        var nodule, promise, _i, _len;
        for (_i = 0, _len = nodules.length; _i < _len; _i++) {
          nodule = nodules[_i];
          inject.push(nodule);
        }
        promise = fn.apply(_this, inject);
        if ((promise != null) && (promise.then != null)) {
          return promise.then((function() {}), done);
        }
      }, done);
    } else {
      for (_i = 0, _len = fnArgs.length; _i < _len; _i++) {
        nodule = fnArgs[_i];
        inject.push(require(nodule));
      }
      promise = fn.apply(this, inject);
    }
    if ((promise != null) && (promise.then != null)) {
      return promise.then((function() {}), done);
    }
  };
};
